<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <title>Manage Employees</title>
  <meta name="viewport" content="width=device-width, initial-scale=1.0">

  <!-- Favicon -->
  <link rel="icon" type="image/x-icon" href="data:image/svg+xml;base64,PHN2ZyB4bWxucz0iaHR0cDovL3d3dy53My5vcmcvMjAwMC9zdmciIHdpZHRoPSIzMiIgaGVpZ2h0PSIzMiIgdmlld0JveD0iMCAwIDI0IDI0IiBmaWxsPSJub25lIiBzdHJva2U9IiM2QjQ2QzEiIHN0cm9rZS13aWR0aD0iMiIgc3Ryb2tlLWxpbmVjYXA9InJvdW5kIiBzdHJva2UtbGluZWpvaW49InJvdW5kIj48cGF0aCBkPSJNMTYgMjF2LTJhNCA0IDAgMCAwLTQtNEg2YTQgNCAwIDAgMC00IDR2MiI+PC9wYXRoPjxjaXJjbGUgY3g9IjkiIGN5PSI3IiByPSI0Ij48L2NpcmNsZT48cGF0aCBkPSJtMjIgMjEtMy0zIj48L3BhdGg+PHBhdGggZD0ibTIyIDIxLTMtMyI+PC9wYXRoPjwvc3ZnPg==">

  <script src="https://cdn.tailwindcss.com"></script>
  <link href="https://fonts.googleapis.com/css2?family=DM+Sans:wght@300;400;500;600;700&display=swap" rel="stylesheet">
  <style>
    /* Item Design System Variables */
    :root {
      --item-purple: #6B46C1;
      --item-purple-light: #8B5CF6;
      --item-purple-dark: #553C9A;
      --item-orange: #F97316;
      --item-orange-light: #FB923C;
      --item-white: #FFFFFF;
      --item-black: #000000;
      --item-lavender: #E6E6FA;
      --item-lilac: #C8A2C8;
      --item-mist: #F2F2F2;
      --item-dove: #E6E6E6;
      --item-steel: #CCCCCC;
      --item-slate: #808080;
      --item-iron: #666666;
      --item-shadow: #4D4D4D;
    }

    /* Clean animations */
    @keyframes fadeIn {
      from { opacity: 0; transform: translateY(8px); }
      to { opacity: 1; transform: translateY(0); }
    }

    @keyframes slideDown {
      from { opacity: 0; transform: translateY(-12px); }
      to { opacity: 1; transform: translateY(0); }
    }

    @keyframes modalAppear {
      from { opacity: 0; transform: scale(0.95); }
      to { opacity: 1; transform: scale(1); }
    }

    .animate-fade-in {
      animation: fadeIn 0.4s ease-out;
    }

    .animate-slide-down {
      animation: slideDown 0.5s ease-out;
    }

    .animate-modal-appear {
      animation: modalAppear 0.2s ease-out;
    }

    /* Typography system */
    body {
      font-family: 'DM Sans', -apple-system, BlinkMacSystemFont, 'Segoe UI', sans-serif;
      font-weight: 400;
      line-height: 1.5;
      -webkit-font-smoothing: antialiased;
      -moz-osx-font-smoothing: grayscale;
    }

    .font-geometric {
      font-family: 'DM Sans', sans-serif;
      letter-spacing: -0.01em;
    }

    /* Cards and containers */
    .item-card {
      background: var(--item-white);
      border-radius: 12px;
      box-shadow: 
        0 1px 3px rgba(0, 0, 0, 0.06),
        0 1px 2px rgba(0, 0, 0, 0.08);
      border: 1px solid var(--item-dove);
    }

    /* Input styling */
    .item-input {
      background: var(--item-white);
      border: 1.5px solid var(--item-dove);
      border-radius: 8px;
      transition: all 0.2s ease;
      font-weight: 400;
    }

    .item-input:focus {
      outline: none;
      border-color: var(--item-purple);
      box-shadow: 0 0 0 3px rgba(107, 70, 193, 0.08);
    }

    /* Button styling */
    .item-button {
      background: var(--item-purple);
      border-radius: 8px;
      font-weight: 500;
      letter-spacing: -0.01em;
      transition: all 0.2s ease;
    }

    .item-button:hover {
      background: var(--item-purple-dark);
      transform: translateY(-1px);
      box-shadow: 0 4px 12px rgba(107, 70, 193, 0.15);
    }

    .item-button:active {
      transform: translateY(0);
    }

    .item-button-secondary {
      background: var(--item-mist);
      color: var(--item-shadow);
      border-radius: 8px;
      font-weight: 500;
      transition: all 0.2s ease;
    }

    .item-button-secondary:hover {
      background: var(--item-dove);
      transform: translateY(-1px);
    }

    .item-button-danger {
      background: #DC2626;
      border-radius: 8px;
      font-weight: 500;
      transition: all 0.2s ease;
    }

    .item-button-danger:hover {
      background: #B91C1C;
      transform: translateY(-1px);
    }

    .item-button-danger:disabled {
      background: var(--item-steel);
      cursor: not-allowed;
      transform: none;
    }

    /* Role badges */
    .role-badge {
      display: inline-block;
      padding: 4px 8px;
      border-radius: 6px;
      font-size: 11px;
      font-weight: 500;
      text-transform: uppercase;
      letter-spacing: 0.03em;
    }

    .role-badge.staff {
      background: #EFF6FF;
      color: #1D4ED8;
      border: 1px solid #DBEAFE;
    }

    .role-badge.admin {
      background: #FEF3C7;
      color: #D97706;
      border: 1px solid #FDE68A;
    }

    /* Table styling */
    .table-row {
      transition: all 0.2s ease;
      border-radius: 8px;
    }

    .table-row:hover {
      background: var(--item-mist);
      transform: translateY(-1px);
      box-shadow: 0 2px 8px rgba(0, 0, 0, 0.04);
    }

    /* Notification system */
    .notification {
      position: fixed;
      top: 20px;
      right: 20px;
      z-index: 1000;
      transform: translateX(400px);
      opacity: 0;
      transition: all 0.3s ease;
      border-radius: 8px;
      box-shadow: 0 4px 12px rgba(0, 0, 0, 0.1);
    }

    .notification.show {
      transform: translateX(0);
      opacity: 1;
    }

    .notification.success {
      background: #10B981;
      color: white;
    }

    .notification.error {
      background: #DC2626;
      color: white;
    }

    /* Modal styling */
    .modal-overlay {
      background-color: rgba(0, 0, 0, 0.4);
      backdrop-filter: blur(2px);
    }

    /* Loading spinner */
    .loading-spinner {
      width: 16px;
      height: 16px;
      border: 2px solid var(--item-dove);
      border-top: 2px solid var(--item-purple);
      border-radius: 50%;
      animation: spin 1s linear infinite;
    }

    @keyframes spin {
      0% { transform: rotate(0deg); }
      100% { transform: rotate(360deg); }
    }

    /* Clean background */
    .item-background {
      background: #FAFAFA;
    }

    /* Upload area styling */
    .upload-area {
      border: 2px dashed var(--item-dove);
      border-radius: 8px;
      transition: all 0.2s ease;
      cursor: pointer;
    }

    .upload-area:hover {
      border-color: var(--item-purple);
      background: var(--item-mist);
    }

    /* Empty state styling */
    .empty-state {
      color: var(--item-slate);
    }
  </style>
</head>
<body class="min-h-screen item-background font-geometric">
  <!-- Notification System -->
  <div id="notification" class="notification px-4 py-3">
    <div class="flex items-center">
      <div id="notificationIcon" class="mr-3"></div>
      <span id="notificationText" class="text-sm font-medium"></span>
    </div>
  </div>

  <!-- Edit Modal -->
  <div id="editModal" class="fixed inset-0 z-50 hidden">
    <div class="modal-overlay absolute inset-0" onclick="closeEditModal()"></div>
    <div class="flex items-center justify-center min-h-screen p-4">
      <div class="item-card max-w-md w-full mx-auto animate-modal-appear relative z-10">
        <div class="px-6 py-4 border-b" style="border-color: var(--item-dove);">
          <h3 class="text-lg font-semibold text-gray-900 flex items-center">
            <svg xmlns="http://www.w3.org/2000/svg" width="18" height="18" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="mr-2" style="color: var(--item-purple);">
              <path d="M17 3a2.85 2.83 0 1 1 4 4L7.5 20.5 2 22l1.5-5.5Z"/>
              <path d="m15 5 4 4"/>
            </svg>
            Edit Employee
          </h3>
        </div>

        <form id="editEmployeeForm" class="p-6 space-y-4">
          <input type="hidden" id="editEmployeeId">

          <!-- Full Name -->
          <div class="space-y-2">
            <label class="text-sm font-medium text-gray-700">Full Name</label>
            <input type="text" id="editName" name="name" required
                   class="item-input w-full px-3 py-2.5 text-gray-900 placeholder-gray-500">
          </div>

          <!-- Email -->
          <div class="space-y-2">
            <label class="text-sm font-medium text-gray-700">Email Address</label>
            <input type="email" id="editEmail" name="email" required
                   class="item-input w-full px-3 py-2.5 text-gray-900 placeholder-gray-500">
          </div>

          <!-- Phone -->
          <div class="space-y-2">
            <label class="text-sm font-medium text-gray-700">Phone (Optional)</label>
            <input type="text" id="editPhone" name="phone"
                   class="item-input w-full px-3 py-2.5 text-gray-900 placeholder-gray-500">
          </div>

          <!-- Password -->
          <div class="space-y-2">
            <label class="text-sm font-medium text-gray-700">New Password (leave empty to keep current)</label>
            <input type="password" id="editPassword" name="password"
                   class="item-input w-full px-3 py-2.5 text-gray-900 placeholder-gray-500">
          </div>

          <!-- Role -->
          <div class="space-y-2">
            <label class="text-sm font-medium text-gray-700">Role</label>
            <select id="editRole" name="role"
                    class="item-input w-full px-3 py-2.5 text-gray-900">
              <option value="staff">Staff</option>
              <option value="admin">Admin</option>
            </select>
          </div>

          <!-- Buttons -->
          <div class="flex space-x-3 pt-4">
            <button type="button" onclick="closeEditModal()"
                    class="item-button-secondary flex-1 px-4 py-2.5 text-sm font-medium">
              Cancel
            </button>
            <button type="submit"
                    class="item-button flex-1 px-4 py-2.5 text-white text-sm font-medium">
              Update Employee
            </button>
          </div>
        </form>
      </div>
    </div>
  </div>

  <div class="container mx-auto px-6 py-8">
    <!-- Header Section -->
    <div class="mb-8 transform animate-slide-down">
      <div class="item-card">
        <header class="relative px-6 py-8">
          <div class="flex items-center">
            <div class="w-12 h-12 bg-gray-100 rounded-lg flex items-center justify-center mr-4">
              <svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" style="color: var(--item-purple);">
                <path d="M16 21v-2a4 4 0 0 0-4-4H6a4 4 0 0 0-4 4v2"></path>
                <circle cx="9" cy="7" r="4"></circle>
                <path d="m22 21-3-3"></path>
                <path d="m22 21-3-3"></path>
              </svg>
            </div>
            <div>
              <h1 class="text-2xl font-semibold text-gray-900">Employee Management</h1>
              <p class="text-gray-600 mt-1">Manage your team members and access controls</p>
            </div>
          </div>
        </header>
      </div>
    </div>

    <div class="grid grid-cols-1 lg:grid-cols-3 gap-8">
      <!-- Search Bar Section -->
      <div class="lg:col-span-3 mb-6">
        <div class="item-card">
          <div class="px-6 py-4 border-b" style="border-color: var(--item-dove);">
            <h2 class="text-lg font-semibold text-gray-900 flex items-center">
              <svg xmlns="http://www.w3.org/2000/svg" width="18" height="18" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="mr-2" style="color: var(--item-purple);">
                <circle cx="11" cy="11" r="8"></circle>
                <path d="m21 21-4.35-4.35"></path>
              </svg>
              Search Visitors
            </h2>
          </div>

          <div class="p-6">
            <div class="max-w-md mx-auto">
              <div class="relative">
                <div class="absolute inset-y-0 left-0 pl-3 flex items-center pointer-events-none">
                  <svg xmlns="http://www.w3.org/2000/svg" width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="text-gray-400">
                    <circle cx="11" cy="11" r="8"></circle>
                    <path d="m21 21-4.35-4.35"></path>
                  </svg>
                </div>
                <input type="text" id="visitorSearch" placeholder="Search visitors by name, email, or phone..."
                       class="item-input w-full pl-10 pr-4 py-2.5 text-gray-700 placeholder-gray-500">
              </div>

              <!-- Search Results -->
              <div id="searchResults" class="mt-4 hidden">
                <div class="item-card">
                  <div class="p-4">
                    <h3 class="text-sm font-semibold text-gray-700 mb-3">Search Results</h3>
                    <div id="searchResultsList" class="space-y-2 max-h-60 overflow-y-auto">
                      <!-- Search results will be populated here -->
                    </div>
                  </div>
                </div>
              </div>

              <!-- No Results Message -->
              <div id="noResults" class="mt-4 hidden">
                <div class="bg-gray-50 rounded-lg p-4 text-center">
                  <svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="mx-auto text-gray-400 mb-2">
                    <circle cx="11" cy="11" r="8"></circle>
                    <path d="m21 21-4.35-4.35"></path>
                  </svg>
                  <p class="text-gray-500 text-sm">No visitors found matching your search.</p>
                </div>
              </div>

              <!-- Loading State -->
              <div id="searchLoading" class="mt-4 hidden">
                <div class="bg-blue-50 rounded-lg p-4 text-center">
                  <div class="flex items-center justify-center space-x-2">
                    <div class="loading-spinner"></div>
                    <span class="text-blue-600 text-sm">Searching visitors...</span>
                  </div>
                </div>
              </div>
            </div>
          </div>
        </div>
      </div>

      <!-- Add Employee Form -->
      <div class="lg:col-span-1 transform animate-fade-in">
        <div class="item-card">
          <div class="px-6 py-4 border-b" style="border-color: var(--item-dove);">
            <h2 class="text-lg font-semibold text-gray-900 flex items-center">
              <svg xmlns="http://www.w3.org/2000/svg" width="18" height="18" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="mr-2" style="color: var(--item-purple);">
                <path d="M16 21v-2a4 4 0 0 0-4-4H6a4 4 0 0 0-4 4v2"></path>
                <circle cx="9" cy="7" r="4"></circle>
                <line x1="22" y1="11" x2="16" y2="11"></line>
                <line x1="19" y1="8" x2="19" y2="14"></line>
              </svg>
              Add New Employee
            </h2>
          </div>

          <div class="p-6">
            <form id="employeeForm" class="space-y-4">
              <!-- Full Name -->
              <div class="space-y-2">
                <label class="text-sm font-medium text-gray-700">Full Name</label>
                <input type="text" name="name" required
                       class="item-input w-full px-3 py-2.5 text-gray-900 placeholder-gray-500"
                       placeholder="Enter full name">
              </div>

              <!-- Profile Photo Upload -->
              <div class="space-y-2">
                <label class="text-sm font-medium text-gray-700">Profile Photo (Optional)</label>
                <div class="relative">
                  <input type="file" id="profilePhoto" name="profile_photo" accept="image/*"
                         class="absolute inset-0 w-full h-full opacity-0 cursor-pointer z-10"
                         onchange="handlePhotoUpload(this, 'photoPreview')">
                  <div class="upload-area w-full px-4 py-3">
                    <div class="flex items-center justify-center space-x-3">
                      <div id="photoPreview" class="w-10 h-10 bg-gray-100 rounded-full flex items-center justify-center">
                        <svg xmlns="http://www.w3.org/2000/svg" width="18" height="18" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="text-gray-400">
                          <path d="M14.5 4h-5L7 7H4a2 2 0 0 0-2 2v9a2 2 0 0 0 2 2h16a2 2 0 0 0 2-2V9a2 2 0 0 0-2-2h-3l-2.5-3z"/>
                          <circle cx="12" cy="13" r="3"/>
                        </svg>
                      </div>
                      <div class="text-center">
                        <p class="text-sm text-gray-600">Click to upload photo</p>
                        <p class="text-xs text-gray-400">JPG, PNG up to 5MB</p>
                      </div>
                    </div>
                  </div>
                </div>
              </div>

              <!-- Email -->
              <div class="space-y-2">
                <label class="text-sm font-medium text-gray-700">Email Address</label>
                <input type="email" name="email" required
                       class="item-input w-full px-3 py-2.5 text-gray-900 placeholder-gray-500"
                       placeholder="Enter email address">
              </div>

              <!-- Phone -->
              <div class="space-y-2">
                <label class="text-sm font-medium text-gray-700">Phone (Optional)</label>
                <input type="text" name="phone"
                       class="item-input w-full px-3 py-2.5 text-gray-900 placeholder-gray-500"
                       placeholder="Enter phone number">
              </div>

              <!-- Password -->
              <div class="space-y-2">
                <label class="text-sm font-medium text-gray-700">Password</label>
                <input type="password" name="password" required
                       class="item-input w-full px-3 py-2.5 text-gray-900 placeholder-gray-500"
                       placeholder="Enter password">
              </div>

              <!-- Role -->
              <div class="space-y-2">
                <label class="text-sm font-medium text-gray-700">Role</label>
                <select name="role"
                        class="item-input w-full px-3 py-2.5 text-gray-900">
                  <option value="staff">Staff</option>
                  <option value="admin">Admin</option>
                </select>
              </div>

              <!-- Submit Button -->
              <button type="submit"
                      class="item-button w-full px-4 py-2.5 text-white text-sm font-medium mt-6">
                <span class="flex items-center justify-center">
                  <svg xmlns="http://www.w3.org/2000/svg" width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="mr-2">
                    <line x1="12" y1="5" x2="12" y2="19"></line>
                    <line x1="5" y1="12" x2="19" y2="12"></line>
                  </svg>
                  Add Employee
                </span>
              </button>
            </form>
          </div>
        </div>
      </div>

      <!-- Employee Table -->
      <div class="lg:col-span-2 transform animate-fade-in" style="animation-delay: 0.1s;">
        <div class="item-card">
          <div class="px-6 py-4 border-b flex items-center justify-between" style="border-color: var(--item-dove);">
            <h2 class="text-lg font-semibold text-gray-900 flex items-center">
              <svg xmlns="http://www.w3.org/2000/svg" width="18" height="18" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="mr-2" style="color: var(--item-purple);">
                <path d="M16 21v-2a4 4 0 0 0-4-4H6a4 4 0 0 0-4 4v2"></path>
                <circle cx="9" cy="7" r="4"></circle>
                <path d="m22 21-3-3"></path>
                <path d="m22 21-3-3"></path>
              </svg>
              Current Employees
            </h2>
            <span id="employeeCount" class="px-2 py-1 bg-gray-100 text-gray-600 rounded-md text-sm font-medium">0</span>
          </div>

          <div class="p-6">
            <div class="overflow-x-auto">
              <table class="w-full text-sm">
                <thead>
                  <tr class="border-b" style="border-color: var(--item-dove);">
                    <th class="text-left py-3 px-3 font-medium text-gray-700">ID</th>
                    <th class="text-left py-3 px-3 font-medium text-gray-700">Photo</th>
                    <th class="text-left py-3 px-3 font-medium text-gray-700">Name</th>
                    <th class="text-left py-3 px-3 font-medium text-gray-700">Email</th>
                    <th class="text-left py-3 px-3 font-medium text-gray-700">Phone</th>
                    <th class="text-left py-3 px-3 font-medium text-gray-700">Role</th>
                    <th class="text-left py-3 px-3 font-medium text-gray-700">Actions</th>
                  </tr>
                </thead>
                <tbody id="employeeTableBody">
                  <!-- Dynamic content will be inserted here -->
                </tbody>
              </table>

              <!-- Empty State -->
              <div id="emptyState" class="text-center py-12 hidden">
                <div class="w-16 h-16 bg-gray-100 rounded-full flex items-center justify-center mx-auto mb-4">
                  <svg xmlns="http://www.w3.org/2000/svg" width="28" height="28" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="1.5" stroke-linecap="round" stroke-linejoin="round" class="text-gray-400">
                    <path d="M16 21v-2a4 4 0 0 0-4-4H6a4 4 0 0 0-4 4v2"></path>
                    <circle cx="9" cy="7" r="4"></circle>
                    <path d="m22 21-3-3"></path>
                    <path d="m22 21-3-3"></path>
                  </svg>
                </div>
                <h3 class="text-lg font-medium text-gray-900 mb-2">No employees found</h3>
                <p class="text-gray-500">Add your first employee using the form on the left.</p>
              </div>
            </div>
          </div>
        </div>
      </div>
    </div>
  </div>

  <script>
    // Global variables
    let currentUserRole = 'staff';
    let currentUserId = null;

    // Photo upload handler
    function handlePhotoUpload(input, previewId) {
      const file = input.files[0];
      const preview = document.getElementById(previewId);

      if (file) {
        // Validate file size (5MB max)
        if (file.size > 5 * 1024 * 1024) {
          showNotification('Photo size must be less than 5MB', 'error');
          input.value = '';
          return;
        }

        // Validate file type
        if (!file.type.match(/^image\/(jpeg|jpg|png|gif)$/)) {
          showNotification('Please select a valid image file (JPG, PNG, GIF)', 'error');
          input.value = '';
          return;
        }

        // Create preview
        const reader = new FileReader();
        reader.onload = function(e) {
          preview.innerHTML = `<img src="${e.target.result}" alt="Preview" class="w-full h-full object-cover rounded-full">`;
        };
        reader.readAsDataURL(file);
      }
    }

    // Upload photo to server and return URL
    async function uploadPhoto(file) {
      const formData = new FormData();
      formData.append('photo', file);

      try {
        const response = await fetch('/api/upload/photo', {
          method: 'POST',
          body: formData
        });

        if (response.ok) {
          const result = await response.json();
          return result.url;
        } else {
          throw new Error('Upload failed');
        }
      } catch (error) {
        console.error('Error uploading photo:', error);
        throw error;
      }
    }

    let searchTimeout = null;

    // Visitor search functionality
    function initializeVisitorSearch() {
      const searchInput = document.getElementById('visitorSearch');
      const searchResults = document.getElementById('searchResults');
      const searchResultsList = document.getElementById('searchResultsList');
      const noResults = document.getElementById('noResults');
      const searchLoading = document.getElementById('searchLoading');

      searchInput.addEventListener('input', function(e) {
        const query = e.target.value.trim();

        if (searchTimeout) {
          clearTimeout(searchTimeout);
        }

        searchResults.classList.add('hidden');
        noResults.classList.add('hidden');
        searchLoading.classList.add('hidden');

        if (query.length < 2) {
          return;
        }

        searchLoading.classList.remove('hidden');

        searchTimeout = setTimeout(() => {
          searchVisitors(query);
        }, 500);
      });
    }

    async function searchVisitors(query) {
      const searchResults = document.getElementById('searchResults');
      const searchResultsList = document.getElementById('searchResultsList');
      const noResults = document.getElementById('noResults');
      const searchLoading = document.getElementById('searchLoading');

      try {
        const response = await fetch(`/api/visitors/search?q=${encodeURIComponent(query)}`);
        const visitors = await response.json();

        searchLoading.classList.add('hidden');

        if (visitors.length === 0) {
          noResults.classList.remove('hidden');
          return;
        }

        searchResultsList.innerHTML = '';

        visitors.forEach(visitor => {
          const resultItem = document.createElement('div');
          resultItem.className = 'p-3 bg-gray-50 rounded-lg border hover:bg-white cursor-pointer transition-all duration-200';
          resultItem.onclick = () => viewVisitorRegistration(visitor.id);

          resultItem.innerHTML = `
            <div class="flex items-center justify-between">
              <div class="flex-1">
                <div class="flex items-center mb-1">
                  <div class="w-6 h-6 bg-gray-200 rounded-full flex items-center justify-center text-gray-600 text-xs font-medium mr-2">
                    ${visitor.name.charAt(0).toUpperCase()}
                  </div>
                  <h4 class="font-medium text-gray-900 text-sm">${visitor.name}</h4>
                </div>
                <p class="text-xs text-gray-600">${visitor.email}</p>
                ${visitor.phone ? `<p class="text-xs text-gray-500">${visitor.phone}</p>` : ''}
                ${visitor.visit_date ? `<p class="text-xs text-blue-600">Visit: ${formatDate(visitor.visit_date)}</p>` : ''}
              </div>
              <div class="ml-3">
                <svg xmlns="http://www.w3.org/2000/svg" width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="text-gray-400">
                  <path d="m9 18 6-6-6-6"/>
                </svg>
              </div>
            </div>
          `;

          searchResultsList.appendChild(resultItem);
        });

        searchResults.classList.remove('hidden');

      } catch (error) {
        console.error('Error searching visitors:', error);
        searchLoading.classList.add('hidden');
        showNotification('Error searching visitors', 'error');
      }
    }

    function viewVisitorRegistration(visitorId) {
      window.location.href = `/view-registrations?visitor_id=${visitorId}`;
    }

    function formatDate(dateString) {
      const date = new Date(dateString);
      return date.toLocaleDateString('en-US', {
        year: 'numeric',
        month: 'short',
        day: 'numeric',
        hour: '2-digit',
        minute: '2-digit'
      });
    }

    // Check user permissions
    function checkUserPermissions() {
      fetch('/api/user/session')
        .then(response => {
          if (response.ok) {
            return response.json();
          }
        })
        .then(userData => {
          if (userData) {
            currentUserRole = userData.role || 'staff';
            currentUserId = userData.id;

            if (currentUserRole !== 'admin') {
              hideAdminFeatures();
            }
          }
        })
        .catch(error => {
          console.error('Error checking permissions:', error);
          currentUserRole = 'staff';
          hideAdminFeatures();
        });
    }

    function hideAdminFeatures() {
      const addEmployeeSection = document.querySelector('.lg\\:col-span-1');
      if (addEmployeeSection) {
        addEmployeeSection.style.display = 'none';
      }

      const tableSection = document.querySelector('.lg\\:col-span-2');
      if (tableSection) {
        tableSection.className = tableSection.className.replace('lg:col-span-2', 'lg:col-span-3');
      }
    }

    // Notification system
    function showNotification(message, type = 'success') {
      const notification = document.getElementById('notification');
      const notificationText = document.getElementById('notificationText');
      const notificationIcon = document.getElementById('notificationIcon');

      notification.className = `notification ${type} px-4 py-3`;
      notificationText.textContent = message;

      if (type === 'success') {
        notificationIcon.innerHTML = `
          <svg xmlns="http://www.w3.org/2000/svg" width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
            <path d="M22 11.08V12a10 10 0 1 1-5.93-9.14"></path>
            <polyline points="22,4 12,14.01 9,11.01"></polyline>
          </svg>
        `;
      } else {
        notificationIcon.innerHTML = `
          <svg xmlns="http://www.w3.org/2000/svg" width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
            <circle cx="12" cy="12" r="10"></circle>
            <line x1="15" y1="9" x2="9" y2="15"></line>
            <line x1="9" y1="9" x2="15" y2="15"></line>
          </svg>
        `;
      }

      notification.classList.add('show');

      setTimeout(() => {
        notification.classList.remove('show');
      }, 4000);
    }

    // Modal functions
    function openEditModal(employee) {
		document.getElementById('editEmployeeId').value = employee.id;
		document.getElementById('editName').value = employee.name;
		document.getElementById('editEmail').value = employee.email;
		document.getElementById('editPhone').value = employee.phone || '';
		document.getElementById('editPassword').value = '';
		document.getElementById('editRole').value = employee.role;

		document.getElementById('editModal').classList.remove('hidden');
		document.body.style.overflow = 'hidden';
    }

    function closeEditModal() {
		document.getElementById('editModal').classList.add('hidden');
		document.body.style.overflow = 'auto';
    }

    // Load employees function
    async function loadEmployees() {
      try {
        const res = await fetch('/api/employee/list');
        const data = await res.json();
        const tbody = document.getElementById('employeeTableBody');
        const emptyState = document.getElementById('emptyState');
        const employeeCount = document.getElementById('employeeCount');

        tbody.innerHTML = '';
        employeeCount.textContent = data.length;

        if (data.length === 0) {
          emptyState.classList.remove('hidden');
        } else {
          emptyState.classList.add('hidden');

          data.forEach((emp, index) => {
            const row = document.createElement('tr');
            row.className = 'table-row border-b';
            row.style.animationDelay = `${index * 0.05}s`;
            row.classList.add('animate-fade-in');
            row.style.borderColor = 'var(--item-dove)';
            row.innerHTML = `
              <td class="py-3 px-3 text-gray-700 font-medium">#${emp.id}</td>
              <td class="py-3 px-3">
                <div class="w-8 h-8 rounded-full flex items-center justify-center overflow-hidden">
                  ${emp.profile_photo ?
                    `<img src="${emp.profile_photo}" alt="${emp.name}" class="w-full h-full object-cover rounded-full">` :
                    `<div class="w-full h-full bg-gray-100 rounded-full flex items-center justify-center text-gray-600 text-xs font-medium">${emp.name.charAt(0).toUpperCase()}</div>`
                  }
                </div>
              </td>
              <td class="py-3 px-3">
                <span class="font-medium text-gray-900 text-sm">${emp.name}</span>
              </td>
              <td class="py-3 px-3 text-gray-700 text-sm">${emp.email}</td>
              <td class="py-3 px-3 text-gray-500 text-sm">${emp.phone || '<span class="italic text-gray-400">Not provided</span>'}</td>
              <td class="py-3 px-3">
                <span class="role-badge ${emp.role}">${emp.role}</span>
              </td>
              <td class="py-3 px-3">
                ${currentUserRole === 'admin' ? `
                <div class="flex space-x-2">
                  <button class="item-button-secondary px-2 py-1 text-xs"
                          onclick="openEditModal(${JSON.stringify(emp).replace(/"/g, '&quot;')})">
                    Edit
                  </button>
                  <button class="item-button-danger px-2 py-1 text-xs text-white ${emp.role === 'admin' ? 'item-button-danger:disabled' : ''}"
                          onclick="deleteEmployee(${emp.id}, '${emp.role}')"
                          ${emp.role === 'admin' ? 'disabled title="Cannot delete admin users"' : ''}>
                    Delete
                  </button>
                </div>
                ` : '<span class="text-gray-400 text-xs italic">Admin access required</span>'}
              </td>
            `;

            tbody.appendChild(row);
          });
        }
      } catch (error) {
        console.error('Error loading employees:', error);
        showNotification('Failed to load employees', 'error');
      }
    }

    // Form submission for adding new employee
    document.getElementById('employeeForm').addEventListener('submit', async e => {
      e.preventDefault();

      const formData = new FormData(e.target);
      const submitButton = e.target.querySelector('button[type="submit"]');
      const photoFile = document.getElementById('profilePhoto').files[0];

      submitButton.disabled = true;
      submitButton.innerHTML = `
        <span class="flex items-center justify-center">
          <div class="loading-spinner mr-2"></div>
          Adding Employee...
        </span>
      `;

      try {
        if (photoFile) {
          try {
            const photoUrl = await uploadPhoto(photoFile);
            formData.append('profile_photo_url', photoUrl);
          } catch (photoError) {
            showNotification('Failed to upload photo. Employee will be created without profile photo.', 'error');
          }
        }

        const res = await fetch('/api/employee/create', {
          method: 'POST',
          body: formData
        });
        const result = await res.json();

        if (res.ok) {
          showNotification('Employee added successfully!', 'success');
          e.target.reset();
          document.getElementById('photoPreview').innerHTML = `
            <svg xmlns="http://www.w3.org/2000/svg" width="18" height="18" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="text-gray-400">
              <path d="M14.5 4h-5L7 7H4a2 2 0 0 0-2 2v9a2 2 0 0 0 2 2h16a2 2 0 0 0 2-2V9a2 2 0 0 0-2-2h-3l-2.5-3z"/>
              <circle cx="12" cy="13" r="3"/>
            </svg>
          `;
          loadEmployees();
        } else {
          showNotification('Error: ' + (result.error || 'Unknown error occurred'), 'error');
        }
      } catch (error) {
        console.error('Error creating employee:', error);
        showNotification('Network error occurred', 'error');
      } finally {
        submitButton.disabled = false;
        submitButton.innerHTML = `
          <span class="flex items-center justify-center">
            <svg xmlns="http://www.w3.org/2000/svg" width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="mr-2">
              <line x1="12" y1="5" x2="12" y2="19"></line>
              <line x1="5" y1="12" x2="19" y2="12"></line>
            </svg>
            Add Employee
          </span>
        `;
      }
    });

    // Form submission for editing employee
    document.getElementById('editEmployeeForm').addEventListener('submit', async e => {
      e.preventDefault();

      const formData = new FormData(e.target);
      const employeeId = document.getElementById('editEmployeeId').value;
      const submitButton = e.target.querySelector('button[type="submit"]');
      const photoFile = document.getElementById('editProfilePhoto');

      submitButton.disabled = true;
      submitButton.innerHTML = `
        <div class="loading-spinner mr-2"></div>
        Updating...
      `;

      try {
        if (photoFile && photoFile.files[0]) {
          try {
            const photoUrl = await uploadPhoto(photoFile.files[0]);
            formData.append('profile_photo_url', photoUrl);
          } catch (photoError) {
            showNotification('Failed to upload photo. Employee will be updated without new profile photo.', 'error');
          }
        }

        const res = await fetch(`/api/employee/update/${employeeId}`, {
          method: 'PUT',
          body: formData
        });
        const result = await res.json();

        if (res.ok) {
          showNotification('Employee updated successfully!', 'success');
          closeEditModal();
          loadEmployees();
        } else {
          showNotification('Error: ' + (result.error || 'Unknown error occurred'), 'error');
        }
      } catch (error) {
        console.error('Error updating employee:', error);
        showNotification('Network error occurred', 'error');
      } finally {
        submitButton.disabled = false;
        submitButton.innerHTML = 'Update Employee';
      }
    });

    // Delete employee function with admin protection
    async function deleteEmployee(id, role) {
      if (currentUserRole !== 'admin') {
        showNotification('Access denied. Admin privileges required.', 'error');
        return;
      }

      if (role === 'admin') {
        showNotification('Cannot delete admin users. Please change role to staff first.', 'error');
        return;
      }

      if (!confirm("Are you sure you want to delete this employee? This action cannot be undone.")) return;

      try {
        const res = await fetch(`/api/employee/delete/${id}`, { method: 'DELETE' });
        const result = await res.json();

        if (res.ok) {
          showNotification('Employee deleted successfully', 'success');
          loadEmployees();
        } else {
          showNotification(result.error || 'Failed to delete employee', 'error');
        }
      } catch (error) {
        console.error('Error deleting employee:', error);
        showNotification('Network error occurred', 'error');
      }
    }

    // Close modal when clicking outside
    document.getElementById('editModal').addEventListener('click', function(e) {
      if (e.target === this) {
        closeEditModal();
      }
    });

    // Close modal with Escape key
    document.addEventListener('keydown', function(e) {
      if (e.key === 'Escape' && !document.getElementById('editModal').classList.contains('hidden')) {
        closeEditModal();
      }
    });

    // Load employees on page load
    document.addEventListener('DOMContentLoaded', function() {
      checkUserPermissions();
      loadEmployees();
      initializeVisitorSearch();
    });
  </script>
</body>
</html>