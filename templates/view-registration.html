<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <title>Visitor Details</title>
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <script src="https://cdn.tailwindcss.com"></script>
  <style>
    @keyframes slide-down {
      from {
        opacity: 0;
        transform: translateY(-20px);
      }
      to {
        opacity: 1;
        transform: translateY(0);
      }
    }

    @keyframes fade-in {
      from {
        opacity: 0;
        transform: translateY(10px);
      }
      to {
        opacity: 1;
        transform: translateY(0);
      }
    }

    @keyframes pulse-gentle {
      0%, 100% {
        opacity: 1;
      }
      50% {
        opacity: 0.8;
      }
    }

    .animate-slide-down {
      animation: slide-down 0.6s ease-out;
    }

    .animate-fade-in {
      animation: fade-in 0.4s ease-out;
    }

    .animate-pulse-gentle {
      animation: pulse-gentle 2s infinite;
    }

    .status-badge {
      display: inline-block;
      padding: 8px 16px;
      border-radius: 25px;
      font-size: 14px;
      font-weight: 600;
      text-transform: uppercase;
      letter-spacing: 0.5px;
    }

    .status-badge.pending {
      background: linear-gradient(135deg, #f59e0b, #d97706);
      color: white;
      box-shadow: 0 2px 8px rgba(245, 158, 11, 0.3);
    }

    .status-badge.checked-in {
      background: linear-gradient(135deg, #10b981, #059669);
      color: white;
      box-shadow: 0 2px 8px rgba(16, 185, 129, 0.3);
    }

    .status-badge.checked-out {
      background: linear-gradient(135deg, #6b7280, #4b5563);
      color: white;
      box-shadow: 0 2px 8px rgba(107, 114, 128, 0.3);
    }

    .status-badge.cancelled {
      background: linear-gradient(135deg, #ef4444, #dc2626);
      color: white;
      box-shadow: 0 2px 8px rgba(239, 68, 68, 0.3);
    }

    .notification {
      position: fixed;
      top: 20px;
      right: 20px;
      z-index: 1000;
      transform: translateX(400px);
      opacity: 0;
      transition: all 0.3s ease;
    }

    .notification.show {
      transform: translateX(0);
      opacity: 1;
    }

    .notification.success {
      background: linear-gradient(135deg, #10b981, #059669);
      color: white;
    }

    .notification.error {
      background: linear-gradient(135deg, #ef4444, #dc2626);
      color: white;
    }

    .field-container {
      background: linear-gradient(135deg, rgba(255, 255, 255, 0.9), rgba(248, 250, 252, 0.9));
      border: 1px solid rgba(203, 213, 225, 0.3);
      backdrop-filter: blur(10px);
    }

    .photo-container {
      max-width: 100%;
      max-height: 300px;
      border-radius: 12px;
      overflow: hidden;
      box-shadow: 0 4px 12px rgba(0, 0, 0, 0.1);
      cursor: pointer;
      transition: transform 0.2s;
    }

    .photo-container:hover {
      transform: scale(1.02);
    }

    .qr-code {
      max-width: 200px;
      width: 100%;
      height: auto;
      border-radius: 12px;
      box-shadow: 0 4px 12px rgba(0, 0, 0, 0.1);
      cursor: pointer;
      transition: transform 0.2s;
    }

    .qr-code:hover {
      transform: scale(1.05);
    }

    .modal {
      position: fixed;
      top: 0;
      left: 0;
      width: 100%;
      height: 100%;
      background: rgba(0, 0, 0, 0.8);
      display: flex;
      justify-content: center;
      align-items: center;
      z-index: 1000;
      opacity: 0;
      visibility: hidden;
      transition: all 0.3s ease;
    }

    .modal.show {
      opacity: 1;
      visibility: visible;
    }

    .modal-content {
      max-width: 90%;
      max-height: 90%;
      border-radius: 12px;
      overflow: hidden;
      position: relative;
    }

    .modal img {
      width: 100%;
      height: auto;
      display: block;
    }

    .modal-close {
      position: absolute;
      top: 10px;
      right: 10px;
      background: rgba(0, 0, 0, 0.7);
      color: white;
      border: none;
      border-radius: 50%;
      width: 40px;
      height: 40px;
      cursor: pointer;
      display: flex;
      align-items: center;
      justify-content: center;
    }
  </style>
</head>
<body class="min-h-screen bg-gradient-to-br from-emerald-50 via-blue-50 to-teal-100">
  <!-- Notification System -->
  <div id="notification" class="notification px-6 py-4 rounded-lg shadow-lg backdrop-blur-sm">
    <div class="flex items-center">
      <div id="notificationIcon" class="mr-3"></div>
      <span id="notificationText"></span>
    </div>
  </div>

  <!-- Image Modal -->
  <div id="imageModal" class="modal" onclick="closeModal()">
    <div class="modal-content">
      <button class="modal-close" onclick="closeModal()">
        <svg xmlns="http://www.w3.org/2000/svg" width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
          <line x1="18" y1="6" x2="6" y2="18"></line>
          <line x1="6" y1="6" x2="18" y2="18"></line>
        </svg>
      </button>
      <img id="modalImage" src="" alt="Preview">
    </div>
  </div>

  <div class="container mx-auto px-4 py-8 max-w-2xl">
    <!-- Header Section -->
    <div class="mb-8 transform animate-slide-down">
      <div class="bg-white/80 backdrop-blur-xl rounded-3xl shadow-2xl border border-white/20 overflow-hidden">
        <header class="relative px-8 py-6 bg-gradient-to-r from-emerald-600 to-teal-700 text-white">
          <!-- Decorative Elements -->
          <div class="absolute top-0 right-0 w-32 h-32 bg-white/10 rounded-full -translate-y-16 translate-x-16"></div>
          <div class="absolute bottom-0 left-0 w-24 h-24 bg-white/10 rounded-full translate-y-12 -translate-x-12"></div>

          <div class="relative flex items-center justify-center">
            <div class="flex items-center">
              <div class="w-12 h-12 bg-white/20 rounded-full flex items-center justify-center mr-4">
                <svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="text-white">
                  <path d="M16 21v-2a4 4 0 0 0-4-4H6a4 4 0 0 0-4 4v2"></path>
                  <circle cx="9" cy="7" r="4"></circle>
                  <path d="M2 2l20 20"></path>
                </svg>
              </div>
              <div>
                <h1 class="text-3xl font-bold tracking-tight">Visitor Registration</h1>
                <p class="text-emerald-100 mt-1">Registration details and check-in portal</p>
              </div>
            </div>
          </div>
        </header>
      </div>
    </div>

    <!-- Visitor Details Card -->
    <div class="transform animate-fade-in">
      <div class="bg-white/80 backdrop-blur-xl rounded-3xl shadow-2xl border border-white/20 overflow-hidden">
        <div class="px-6 py-4 bg-gradient-to-r from-indigo-500 to-purple-600 text-white">
          <h2 class="text-xl font-semibold flex items-center">
            <svg xmlns="http://www.w3.org/2000/svg" width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="mr-2">
              <path d="M14 2H6a2 2 0 0 0-2 2v16a2 2 0 0 0 2 2h12a2 2 0 0 0 2-2V8z"></path>
              <polyline points="14,2 14,8 20,8"></polyline>
              <line x1="16" y1="13" x2="8" y2="13"></line>
              <line x1="16" y1="17" x2="8" y2="17"></line>
            </svg>
            Visitor Information
          </h2>
        </div>

        <div class="p-8 space-y-6">
          <!-- Personal Information Section -->
          <div class="bg-gradient-to-br from-gray-50 to-white rounded-2xl p-6 shadow-inner border border-gray-100">
            <h3 class="text-lg font-semibold text-gray-900 mb-4 flex items-center">
              <svg xmlns="http://www.w3.org/2000/svg" width="18" height="18" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="mr-2 text-emerald-600">
                <path d="M19 21v-2a4 4 0 0 0-4-4H9a4 4 0 0 0-4 4v2"></path>
                <circle cx="12" cy="7" r="4"></circle>
              </svg>
              Personal Information
            </h3>

            <div class="grid grid-cols-1 md:grid-cols-2 gap-4">
              <!-- Full Name -->
              <div class="field-container rounded-xl p-4">
                <label class="text-sm font-medium text-gray-700 flex items-center mb-2">
                  <svg xmlns="http://www.w3.org/2000/svg" width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="mr-2 text-emerald-500">
                    <path d="M19 21v-2a4 4 0 0 0-4-4H9a4 4 0 0 0-4 4v2"></path>
                    <circle cx="12" cy="7" r="4"></circle>
                  </svg>
                  Full Name
                </label>
                <span class="text-gray-900 font-medium">{{ visitor.name }}</span>
              </div>

              <!-- Email -->
              <div class="field-container rounded-xl p-4">
                <label class="text-sm font-medium text-gray-700 flex items-center mb-2">
                  <svg xmlns="http://www.w3.org/2000/svg" width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="mr-2 text-blue-500">
                    <path d="m22 7-8.991 5.727a2 2 0 0 1-2.009 0L2 7"></path>
                    <rect x="2" y="4" width="20" height="16" rx="2"></rect>
                  </svg>
                  Email
                </label>
                <span class="text-gray-900">{{ visitor.email }}</span>
              </div>

              <!-- Phone -->
              <div class="field-container rounded-xl p-4">
                <label class="text-sm font-medium text-gray-700 flex items-center mb-2">
                  <svg xmlns="http://www.w3.org/2000/svg" width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="mr-2 text-purple-500">
                    <path d="M22 16.92v3a2 2 0 0 1-2.18 2 19.79 19.79 0 0 1-8.63-3.07 19.5 19.5 0 0 1-6-6 19.79 19.79 0 0 1-3.07-8.67A2 2 0 0 1 4.11 2h3a2 2 0 0 1 2 1.72 12.84 12.84 0 0 0 .7 2.81 2 2 0 0 1-.45 2.11L8.09 9.91a16 16 0 0 0 6 6l1.27-1.27a2 2 0 0 1 2.11-.45 12.84 12.84 0 0 0 2.81.7A2 2 0 0 1 22 16.92z"></path>
                  </svg>
                  Phone
                </label>
                <span class="text-gray-900">{{ visitor.phone or 'N/A' }}</span>
              </div>

              <!-- Status -->
              <div class="field-container rounded-xl p-4">
                <label class="text-sm font-medium text-gray-700 flex items-center mb-2">
                  <svg xmlns="http://www.w3.org/2000/svg" width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="mr-2 text-orange-500">
                    <circle cx="12" cy="12" r="10"></circle>
                    <polyline points="12,6 12,12 16,14"></polyline>
                  </svg>
                  Status
                </label>
                <span class="status-badge {{ visitor.status|lower }}">{{ visitor.status }}</span>
              </div>
            </div>
          </div>

          <!-- Visit Details Section -->
          <div class="bg-gradient-to-br from-gray-50 to-white rounded-2xl p-6 shadow-inner border border-gray-100">
            <h3 class="text-lg font-semibold text-gray-900 mb-4 flex items-center">
              <svg xmlns="http://www.w3.org/2000/svg" width="18" height="18" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="mr-2 text-orange-600">
                <path d="M8 2v4"></path>
                <path d="M16 2v4"></path>
                <rect width="18" height="18" x="3" y="4" rx="2"></rect>
                <path d="M3 10h18"></path>
              </svg>
              Visit Details
            </h3>

            <div class="grid grid-cols-1 md:grid-cols-2 gap-4">
              <!-- Visit Time -->
              <div class="field-container rounded-xl p-4">
                <label class="text-sm font-medium text-gray-700 flex items-center mb-2">
                  <svg xmlns="http://www.w3.org/2000/svg" width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="mr-2 text-orange-500">
                    <circle cx="12" cy="12" r="10"></circle>
                    <polyline points="12,6 12,12 16,14"></polyline>
                  </svg>
                  Visit Time
                </label>
                <span class="text-gray-900">{{ visitor.visit_date }}</span>
              </div>

              <!-- Estimated Time -->
              <div class="field-container rounded-xl p-4">
                <label class="text-sm font-medium text-gray-700 flex items-center mb-2">
                  <svg xmlns="http://www.w3.org/2000/svg" width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="mr-2 text-indigo-500">
                    <clock cx="12" cy="12" r="10"></clock>
                    <polyline points="12,6 12,12 16,14"></polyline>
                  </svg>
                  Estimated Duration
                </label>
                <span class="text-gray-900">{{ visitor.estimate_time if visitor.estimate_time else 'N/A' }}</span>
              </div>

              <!-- Host Employee -->
              <div class="field-container rounded-xl p-4 md:col-span-2">
                <label class="text-sm font-medium text-gray-700 flex items-center mb-2">
                  <svg xmlns="http://www.w3.org/2000/svg" width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="mr-2 text-teal-500">
                    <path d="M16 21v-2a4 4 0 0 0-4-4H6a4 4 0 0 0-4 4v2"></path>
                    <circle cx="9" cy="7" r="4"></circle>
                    <path d="m22 21-3-3"></path>
                  </svg>
                  Host Employee
                </label>
                <span class="text-gray-900 font-medium">{{ host_name }}</span>
              </div>
            </div>
          </div>

          <!-- Documents & QR Code Section -->
          <div class="bg-gradient-to-br from-gray-50 to-white rounded-2xl p-6 shadow-inner border border-gray-100">
            <h3 class="text-lg font-semibold text-gray-900 mb-4 flex items-center">
              <svg xmlns="http://www.w3.org/2000/svg" width="18" height="18" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="mr-2 text-purple-600">
                <path d="M14 2H6a2 2 0 0 0-2 2v16a2 2 0 0 0 2 2h12a2 2 0 0 0 2-2V8z"></path>
                <polyline points="14,2 14,8 20,8"></polyline>
                <line x1="16" y1="13" x2="8" y2="13"></line>
                <line x1="16" y1="17" x2="8" y2="17"></line>
              </svg>
              Documents & QR Code
            </h3>

            <div class="grid grid-cols-1 md:grid-cols-2 gap-6">
              <!-- Photo -->
              <div class="field-container rounded-xl p-4">
                <label class="text-sm font-medium text-gray-700 flex items-center mb-2">
                  <svg xmlns="http://www.w3.org/2000/svg" width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="mr-2 text-green-500">
                    <rect width="18" height="18" x="3" y="3" rx="2" ry="2"></rect>
                    <circle cx="9" cy="9" r="2"></circle>
                    <path d="m21 15-3.086-3.086a2 2 0 0 0-2.828 0L6 21"></path>
                  </svg>
                  Photo
                </label>
                {% if visitor.photo_url %}
                  <div class="photo-container" onclick="openImageModal('{{ visitor.photo_url }}')">
                    <img src="{{ visitor.photo_url }}" class="w-full h-auto">
                  </div>
                {% else %}
                  <span class="text-gray-500">No photo available</span>
                {% endif %}
              </div>

              <!-- Document -->
              <div class="field-container rounded-xl p-4">
                <label class="text-sm font-medium text-gray-700 flex items-center mb-2">
                  <svg xmlns="http://www.w3.org/2000/svg" width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="mr-2 text-amber-500">
                    <path d="M14 2H6a2 2 0 0 0-2 2v16a2 2 0 0 0 2 2h12a2 2 0 0 0 2-2V8z"></path>
                    <polyline points="14,2 14,8 20,8"></polyline>
                    <line x1="16" y1="13" x2="8" y2="13"></line>
                    <line x1="16" y1="17" x2="8" y2="17"></line>
                  </svg>
                  Document
                </label>
                {% if visitor.document_url %}
                  <a href="{{ visitor.document_url }}" target="_blank"
                     class="inline-flex items-center px-4 py-2 bg-gradient-to-r from-blue-500 to-indigo-600 hover:from-blue-600 hover:to-indigo-700 text-white text-sm font-medium rounded-lg transition-all duration-200">
                    <svg xmlns="http://www.w3.org/2000/svg" width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="mr-2">
                      <path d="M18 13v6a2 2 0 0 1-2 2H5a2 2 0 0 1-2-2V8a2 2 0 0 1 2-2h6"></path>
                      <polyline points="15,3 21,3 21,9"></polyline>
                      <line x1="10" y1="14" x2="21" y2="3"></line>
                    </svg>
                    View Document
                  </a>
                {% else %}
                  <span class="text-gray-500">No document available</span>
                {% endif %}
              </div>

              <!-- QR Code -->
              <div class="field-container rounded-xl p-4 md:col-span-2 text-center">
                <label class="text-sm font-medium text-gray-700 flex items-center justify-center mb-4">
                  <svg xmlns="http://www.w3.org/2000/svg" width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="mr-2 text-blue-500">
                    <rect width="5" height="5" x="3" y="3" rx="1"></rect>
                    <rect width="5" height="5" x="16" y="3" rx="1"></rect>
                    <rect width="5" height="5" x="3" y="16" rx="1"></rect>
                    <path d="M21 16h-3a2 2 0 0 0-2 2v3"></path>
                    <path d="M21 21v.01"></path>
                    <path d="M12 7v3a2 2 0 0 1-2 2H7"></path>
                    <path d="M3 12h.01"></path>
                    <path d="M12 3h.01"></path>
                    <path d="M12 16v.01"></path>
                    <path d="M16 12h1"></path>
                    <path d="M21 12v.01"></path>
                    <path d="M12 21v-1"></path>
                  </svg>
                  QR Code for Check-in
                </label>
                {% if visitor.qr_token %}
                  <div class="bg-white p-4 rounded-lg shadow-inner inline-block">
                    <img src="/static/qr/{{ visitor.qr_token }}.png"
                         class="qr-code mx-auto"
                         onclick="openImageModal('/static/qr/{{ visitor.qr_token }}.png')"
                         alt="QR Code for {{ visitor.name }}"
                         onerror="this.parentElement.innerHTML='<span class=&quot;text-red-500 p-4&quot;>QR Code not found</span>'">
                    <p class="text-xs text-gray-600 mt-2">Click to enlarge</p>
                  </div>
                {% else %}
                  <div class="bg-gray-100 p-8 rounded-lg">
                    <svg xmlns="http://www.w3.org/2000/svg" width="48" height="48" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="1" stroke-linecap="round" stroke-linejoin="round" class="mx-auto text-gray-400 mb-2">
                      <rect width="5" height="5" x="3" y="3" rx="1"></rect>
                      <rect width="5" height="5" x="16" y="3" rx="1"></rect>
                      <rect width="5" height="5" x="3" y="16" rx="1"></rect>
                      <path d="M21 16h-3a2 2 0 0 0-2 2v3"></path>
                      <path d="M21 21v.01"></path>
                      <path d="M12 7v3a2 2 0 0 1-2 2H7"></path>
                      <path d="M3 12h.01"></path>
                      <path d="M12 3h.01"></path>
                      <path d="M12 16v.01"></path>
                      <path d="M16 12h1"></path>
                      <path d="M21 12v.01"></path>
                      <path d="M12 21v-1"></path>
                    </svg>
                    <span class="text-gray-500 text-sm">QR code not available</span>
                  </div>
                {% endif %}
              </div>
            </div>
          </div>

          <!-- Action Buttons -->
          {% if visitor.status not in ['cancelled', 'checked_out'] %}
          <div class="space-y-4">
            <!-- Check-in Section -->
            {% if visitor.status == 'pending' %}
            <div class="bg-gradient-to-br from-blue-50 to-indigo-50 rounded-2xl p-6 border border-blue-200">
              <div class="text-center mb-4">
                <h4 class="text-lg font-semibold text-blue-900 mb-2">Already arrived?</h4>
                <p class="text-blue-700 text-sm">Click the button below to check in</p>
              </div>
              <button id="checkinBtn" onclick="submitCheckin()"
                      class="w-full px-6 py-4 bg-gradient-to-r from-blue-500 to-indigo-600 hover:from-blue-600 hover:to-indigo-700 text-white font-semibold rounded-xl shadow-lg hover:shadow-xl transition-all duration-200 transform hover:scale-105 active:scale-95 text-lg">
                <span class="flex items-center justify-center">
                  <svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="mr-2">
                    <path d="M22 11.08V12a10 10 0 1 1-5.93-9.14"/>
                    <polyline points="22,4 12,14.01 9,11.01"/>
                  </svg>
                  Check In
                </span>
              </button>
              <p id="checkin-status" class="text-center mt-3 font-medium hidden"></p>
            </div>
            {% endif %}

            <!-- Check-out Section -->
            {% if visitor.status == 'checked_in' or 1==1%}
            <div class="bg-gradient-to-br from-green-50 to-emerald-50 rounded-2xl p-6 border border-green-200">
              <div class="text-center mb-4">
                <h4 class="text-lg font-semibold text-green-900 mb-2">Ready to leave?</h4>
                <p class="text-green-700 text-sm">Click the button below to check out</p>
              </div>
              <button id="checkoutBtn" onclick="submitCheckout()"
                      class="w-full px-6 py-4 bg-gradient-to-r from-green-500 to-emerald-600 hover:from-green-600 hover:to-emerald-700 text-white font-semibold rounded-xl shadow-lg hover:shadow-xl transition-all duration-200 transform hover:scale-105 active:scale-95 text-lg">
                <span class="flex items-center justify-center">
                  <svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="mr-2">
                    <path d="M9 21H5a2 2 0 0 1-2-2V5a2 2 0 0 1 2-2h4"/>
                    <polyline points="16,17 21,12 16,7"/>
                    <line x1="21" y1="12" x2="9" y2="12"/>
                  </svg>
                  Check Out
                </span>
              </button>
              <p id="checkout-status" class="text-center mt-3 font-medium hidden"></p>
            </div>
            {% endif %}

            <!-- Cancel Section -->
            <div class="bg-gradient-to-br from-red-50 to-pink-50 rounded-2xl p-6 border border-red-200">
              <div class="text-center mb-4">
                <h4 class="text-lg font-semibold text-red-900 mb-2">Need to cancel?</h4>
                <p class="text-red-700 text-sm">This action cannot be undone</p>
              </div>
              <button id="cancelBtn"
                      class="w-full px-6 py-4 bg-gradient-to-r from-red-500 to-pink-600 hover:from-red-600 hover:to-pink-700 text-white font-semibold rounded-xl shadow-lg hover:shadow-xl transition-all duration-200 transform hover:scale-105 active:scale-95 text-lg">
                <span class="flex items-center justify-center">
                  <svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="mr-2">
                    <circle cx="12" cy="12" r="10"/>
                    <line x1="15" y1="9" x2="9" y2="15"/>
                    <line x1="9" y1="9" x2="15" y2="15"/>
                  </svg>
                  Cancel Reservation
                </span>
              </button>
              <div id="cancelStatus" class="text-center mt-3 font-medium hidden"></div>
            </div>
          </div>
          {% endif %}
        </div>
      </div>
    </div>
  </div>

  <script>
    // Notification system
    function showNotification(message, type = 'success') {
      const notification = document.getElementById('notification');
      const notificationText = document.getElementById('notificationText');
      const notificationIcon = document.getElementById('notificationIcon');

      notification.className = `notification ${type} px-6 py-4 rounded-lg shadow-lg backdrop-blur-sm`;
      notificationText.textContent = message;

      if (type === 'success') {
        notificationIcon.innerHTML = `
          <svg xmlns="http://www.w3.org/2000/svg" width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
            <path d="M22 11.08V12a10 10 0 1 1-5.93-9.14"/>
            <polyline points="22,4 12,14.01 9,11.01"/>
          </svg>
        `;
      } else {
        notificationIcon.innerHTML = `
          <svg xmlns="http://www.w3.org/2000/svg" width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
            <circle cx="12" cy="12" r="10"/>
            <line x1="15" y1="9" x2="9" y2="15"/>
            <line x1="9" y1="9" x2="15" y2="15"/>
          </svg>
        `;
      }

      notification.classList.add('show');

      setTimeout(() => {
        notification.classList.remove('show');
      }, 4000);
    }

    // Modal functions
    function openImageModal(src) {
      const modal = document.getElementById('imageModal');
      const modalImage = document.getElementById('modalImage');
      modalImage.src = src;
      modal.classList.add('show');
    }

    function closeModal() {
      const modal = document.getElementById('imageModal');
      modal.classList.remove('show');
    }

    // Cancel reservation functionality
    document.getElementById("cancelBtn").addEventListener("click", function () {
      if (!confirm("Are you sure you want to cancel this reservation? This action cannot be undone.")) return;

      const button = this;
      const originalHTML = button.innerHTML;

      // Show loading state
      button.disabled = true;
      button.innerHTML = `
        <span class="flex items-center justify-center">
          <svg class="animate-spin -ml-1 mr-3 h-6 w-6 text-white" xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24">
            <circle class="opacity-25" cx="12" cy="12" r="10" stroke="currentColor" stroke-width="4"></circle>
            <path class="opacity-75" fill="currentColor" d="M4 12a8 8 0 018-8V0C5.373 0 0 5.373 0 12h4zm2 5.291A7.962 7.962 0 014 12H0c0 3.042 1.135 5.824 3 7.938l3-2.647z"></path>
          </svg>
          Cancelling...
        </span>
      `;

      fetch(window.location.href, {
        method: "POST",
        headers: {
          "Content-Type": "application/x-www-form-urlencoded"
        },
        body: ""
      })
      .then(response => response.text())
      .then(data => {
        const statusDiv = document.getElementById("cancelStatus");
        statusDiv.classList.remove('hidden');
        statusDiv.innerHTML = `
          <div class="flex items-center justify-center text-green-700">
            <svg xmlns="http://www.w3.org/2000/svg" width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="mr-2">
              <path d="M22 11.08V12a10 10 0 1 1-5.93-9.14"/>
              <polyline points="22,4 12,14.01 9,11.01"/>
            </svg>
            Reservation cancelled successfully
          </div>
        `;
        showNotification('Reservation cancelled successfully', 'success');

        // Update status badge
        const statusBadge = document.querySelector('.status-badge');
        statusBadge.className = 'status-badge cancelled';
        statusBadge.textContent = 'CANCELLED';

        // Hide action buttons section
        const actionButtons = button.closest('.space-y-4');
        if (actionButtons) {
          actionButtons.style.display = 'none';
        }
      })
      .catch(error => {
        const statusDiv = document.getElementById("cancelStatus");
        statusDiv.classList.remove('hidden');
        statusDiv.innerHTML = `
          <div class="flex items-center justify-center text-red-700">
            <svg xmlns="http://www.w3.org/2000/svg" width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="mr-2">
              <circle cx="12" cy="12" r="10"/>
              <line x1="15" y1="9" x2="9" y2="15"/>
              <line x1="9" y1="9" x2="15" y2="15"/>
            </svg>
            Failed to cancel reservation
          </div>
        `;
        showNotification('Failed to cancel reservation', 'error');
        console.error("Error:", error);

        // Restore button
        button.disabled = false;
        button.innerHTML = originalHTML;
      });
    });

    // Check-in functionality
    function getQueryParam(key) {
      const params = new URLSearchParams(window.location.search);
      return params.get(key);
    }

    function showCheckinIfNeeded() {
      const t = getQueryParam("t");
      if (t && t !== "h") {
        document.getElementById("checkinBtn").style.display = "block";
      }
    }

    function submitCheckin() {
      const button = document.getElementById("checkinBtn");
      const originalHTML = button.innerHTML;
      const token = window.location.pathname.split("/").pop();

      // Show loading state
      button.disabled = true;
      button.innerHTML = `
        <span class="flex items-center justify-center">
          <svg class="animate-spin -ml-1 mr-3 h-6 w-6 text-white" xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24">
            <circle class="opacity-25" cx="12" cy="12" r="10" stroke="currentColor" stroke-width="4"></circle>
            <path class="opacity-75" fill="currentColor" d="M4 12a8 8 0 018-8V0C5.373 0 0 5.373 0 12h4zm2 5.291A7.962 7.962 0 014 12H0c0 3.042 1.135 5.824 3 7.938l3-2.647z"></path>
          </svg>
          Checking in...
        </span>
      `;

      // Create FormData for the cached endpoint
      const formData = new FormData();
      formData.append('name', "{{ visitor.name }}");
      formData.append('email', "{{ visitor.email }}");
      formData.append('phone', "{{ visitor.phone or '' }}");
      formData.append('visit_date', "{{ visitor.visit_date }}");
      formData.append('estimate_time', "{{ visitor.estimate_time or '' }}");
      formData.append('host_employee', "{{ visitor.host_employee_id if visitor.host_employee_id else '' }}");
      formData.append('location_id', "{{ visitor.location_id if visitor.location_id else '' }}");
      formData.append('qr_token', token);

      fetch(`/api/visitor/checkin`, {
        method: "POST",
        body: formData
      })
      .then(res => {
        if (!res.ok) {
          throw new Error(`HTTP error! status: ${res.status}`);
        }
        return res.json();
      })
      .then(response => {
        if (response.success) {
          const statusElement = document.getElementById("checkin-status");
          statusElement.classList.remove('hidden');
          statusElement.innerHTML = `
            <div class="flex items-center justify-center text-green-700">
              <svg xmlns="http://www.w3.org/2000/svg" width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="mr-2">
                <path d="M22 11.08V12a10 10 0 1 1-5.93-9.14"/>
                <polyline points="22,4 12,14.01 9,11.01"/>
              </svg>
              Check-in successful!
            </div>
          `;
          showNotification('Check-in successful!', 'success');

          // Update status badge
          const statusBadge = document.querySelector('.status-badge');
          statusBadge.className = 'status-badge checked-in';
          statusBadge.textContent = 'CHECKED-IN';

          // Hide check-in section and show check-out section
          const checkinSection = button.closest('.bg-gradient-to-br');
          if (checkinSection) {
            checkinSection.style.display = 'none';
          }

          // Reload page to show checkout button
          setTimeout(() => {
            window.location.reload();
          }, 2000);
        } else {
          throw new Error(response.message || 'Check-in failed');
        }
      })
      .catch(err => {
        const statusElement = document.getElementById("checkin-status");
        statusElement.classList.remove('hidden');
        statusElement.innerHTML = `
          <div class="flex items-center justify-center text-red-700">
            <svg xmlns="http://www.w3.org/2000/svg" width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="mr-2">
              <circle cx="12" cy="12" r="10"/>
              <line x1="15" y1="9" x2="9" y2="15"/>
              <line x1="9" y1="9" x2="15" y2="15"/>
            </svg>
            Check-in failed: ${err.message}
          </div>
        `;
        showNotification(`Check-in failed: ${err.message}`, 'error');
        console.error('Check-in error:', err);

        // Restore button
        button.disabled = false;
        button.innerHTML = originalHTML;
      });
    }

    // Check-out functionality
    function submitCheckout() {
      const button = document.getElementById("checkoutBtn");
      const originalHTML = button.innerHTML;
      const token = window.location.pathname.split("/").pop();

      // Show loading state
      button.disabled = true;
      button.innerHTML = `
        <span class="flex items-center justify-center">
          <svg class="animate-spin -ml-1 mr-3 h-6 w-6 text-white" xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24">
            <circle class="opacity-25" cx="12" cy="12" r="10" stroke="currentColor" stroke-width="4"></circle>
            <path class="opacity-75" fill="currentColor" d="M4 12a8 8 0 018-8V0C5.373 0 0 5.373 0 12h4zm2 5.291A7.962 7.962 0 014 12H0c0 3.042 1.135 5.824 3 7.938l3-2.647z"></path>
          </svg>
          Checking out...
        </span>
      `;

      // Create FormData for checkout
      const formData = new FormData();
      formData.append('qr_token', token);
      formData.append('action', 'checkout');

      fetch(`/api/visitor/checkout`, {
        method: "POST",
        body: formData
      })
      .then(res => {
        if (!res.ok) {
          throw new Error(`HTTP error! status: ${res.status}`);
        }
        return res.json();
      })
      .then(response => {
        if (response.success) {
          const statusElement = document.getElementById("checkout-status");
          statusElement.classList.remove('hidden');
          statusElement.innerHTML = `
            <div class="flex items-center justify-center text-green-700">
              <svg xmlns="http://www.w3.org/2000/svg" width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="mr-2">
                <path d="M22 11.08V12a10 10 0 1 1-5.93-9.14"/>
                <polyline points="22,4 12,14.01 9,11.01"/>
              </svg>
              Check-out successful!
            </div>
          `;
          showNotification('Check-out successful!', 'success');

          // Update status badge
          const statusBadge = document.querySelector('.status-badge');
          statusBadge.className = 'status-badge checked-out';
          statusBadge.textContent = 'CHECKED-OUT';

          // Hide the checkout section and cancel section
          const actionButtons = button.closest('.space-y-4');
          if (actionButtons) {
            actionButtons.style.display = 'none';
          }
        } else {
          throw new Error(response.message || 'Check-out failed');
        }
      })
      .catch(err => {
        const statusElement = document.getElementById("checkout-status");
        statusElement.classList.remove('hidden');
        statusElement.innerHTML = `
          <div class="flex items-center justify-center text-red-700">
            <svg xmlns="http://www.w3.org/2000/svg" width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="mr-2">
              <circle cx="12" cy="12" r="10"/>
              <line x1="15" y1="9" x2="9" y2="15"/>
              <line x1="9" y1="9" x2="15" y2="15"/>
            </svg>
            Check-out failed: ${err.message}
          </div>
        `;
        showNotification(`Check-out failed: ${err.message}`, 'error');
        console.error('Check-out error:', err);

        // Restore button
        button.disabled = false;
        button.innerHTML = originalHTML;
      });
    }

    // Initialize check-in visibility
    showCheckinIfNeeded();

    // Close modal with escape key
    document.addEventListener('keydown', function(e) {
      if (e.key === 'Escape') {
        closeModal();
      }
    });

    // Prevent modal close when clicking image
    document.getElementById('modalImage').addEventListener('click', function(e) {
      e.stopPropagation();
    });
  </script>
</body>
</html>